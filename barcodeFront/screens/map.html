<!DOCTYPE html>
<html>
<head>
    <title>네이버 지도</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?clientId=hjyyov2t3t"></script>
    <style>
        /* 모달 창 스타일 */
        #modal {
            display: none; /* 초기에는 숨겨진 상태 */
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="map" style="width:100%; height:100%;"></div>
    <div id="modal">
        <h2 id="modal-hospital-name"></h2>
        <p id="modal-hospital-address"></p>
        <p id="modal-hospital-phone"></p>
        <p id="modal-hospital-code"></p>
        <button onclick="document.getElementById('modal').style.display='none'">닫기</button>
    </div>
    <script>
        var mapOptions = {
            center: new naver.maps.LatLng(37.3595704, 127.105399),
            zoom: 10
        };

        var map = new naver.maps.Map('map', mapOptions);
        var userMarker = new naver.maps.Marker({ map: map });

        navigator.geolocation.watchPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            map.setCenter(new naver.maps.LatLng(lat, lng));
            userMarker.setPosition(new naver.maps.LatLng(lat, lng));

            // 사용자 위치를 기반으로 실제 병원 정보 가져오기
            fetchHospitalsWithin1KM(lat, lng);
        }, function(error) {
            console.log('Error: ' + error.message);
        }, { enableHighAccuracy: true, maximumAge: 0 });

        // 실제 병원 정보를 가져와서 지도에 마커로 표시하는 함수
        function fetchHospitalsWithin1KM(lat, lng) {
            // 여기에 백엔드 API 호출 로직을 작성하여 1킬로미터 반경 내의 실제 병원 정보를 가져옵니다.
            // 가져온 병원 정보는 createHospitalMarkers 함수를 호출하여 지도에 표시할 수 있습니다.
            // 가져온 데이터는 hospitals 배열에 저장하거나 다른 데이터 구조에 저장합니다.

            // 예시 데이터 대신에 실제 데이터를 가져와서 hospitals 배열에 저장하세요.
            var hospitalsData = [
                {
                    name: "실제 병원 1",
                    lat: 37.12345, // 병원 1의 위도
                    lng: 127.56789, // 병원 1의 경도
                },
                {
                    name: "실제 병원 2",
                    lat: 37.23456, // 병원 2의 위도
                    lng: 127.67890, // 병원 2의 경도
                },
                // 여기에 실제 병원 정보를 추가하세요.
            ];

            // 1킬로미터 반경 내의 실제 병원 정보를 가져온 후 createHospitalMarkers 함수를 호출하여 지도에 마커 생성
            var hospitalsWithin1KM = filterHospitalsWithin1KM(hospitalsData, lat, lng);
            createHospitalMarkers(hospitalsWithin1KM);
        }

        // 1킬로미터 반경 내의 병원 필터링 함수
        function filterHospitalsWithin1KM(hospitals, userLat, userLng) {
            var hospitalsWithin1KM = [];
            var R = 6371; // 지구 반지름 (단위: 킬로미터)

            hospitals.forEach(function(hospital) {
                var lat1 = userLat;
                var lon1 = userLng;
                var lat2 = hospital.lat;
                var lon2 = hospital.lng;

                var dLat = deg2rad(lat2 - lat1);
                var dLon = deg2rad(lon2 - lon1);

                var a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);

                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var distance = R * c; // 두 지점 사이의 거리 (킬로미터)

                if (distance <= 1) { // 1킬로미터 이내의 병원만 추가
                    hospitalsWithin1KM.push(hospital);
                }
            });

            return hospitalsWithin1KM;
        }

        // 각도를 라디안으로 변환하는 함수
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // 병원 정보를 기반으로 지도에 마커를 생성하는 함수
        function createHospitalMarkers(hospitals) {
            hospitals.forEach(function(hospital) {
                var marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(hospital.lat, hospital.lng),
                    map: map,
                    title: hospital.name
                });

                naver.maps.Event.addListener(marker, 'click', function() {
                    document.getElementById('modal-hospital-name').innerText = hospital.name;
                    document.getElementById('modal-hospital-address').innerText = hospital.address;
                    document.getElementById('modal-hospital-phone').innerText = hospital.phone;
                    document.getElementById('modal-hospital-code').innerText = hospital.codename;
                    document.getElementById('modal').style.display = 'block';
                });
            });
        }
    </script>
</body>
</html>
